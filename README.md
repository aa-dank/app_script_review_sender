# UCSC Construction Documents – Email Distribution System

This system automates sending emails with document attachments and Bluebeam Studio session invites. The underlying Apps Script reads distribution data from a Google Spreadsheet and processes each row to send emails using Gmail. This document explains how to correctly fill in your spreadsheet and provides essential details for troubleshooting.

---

## Spreadsheet Structure

Your spreadsheet should include the following columns. Ensure that column header names exactly match these names so the script can correctly map data.

### Required Columns

- **distribution_emails**  
  Primary email addresses (comma-separated) for distribution lists.  
  _Example:_ `user1@example.com, user2@example.com`

- **additional_emails**  
  Additional individual email addresses to include.  
  _Example:_ `extra1@example.com; extra2@example.com`

- **email_body_template**  
  URL of the Google Drive HTML file used as the email body template.  
  _Note:_ The file ID will be extracted from this URL.

- **attachments_urls**  
  Comma or semicolon-separated list of Google Drive file URLs to attach to the email.  
  _Tip:_ After emailing, attachments are trashed, so double-check that the files are not needed later.

- **email_subject_template**  
  URL of a Google Drive file containing the email subject template.  
  This is the only column used for the email subject. It can contain dynamic templating variables. If no templating variables are present, the file’s content will be used as the subject.  
  _Fallback:_ If left empty, the system uses a default subject: specified in configuration.

- **subject_template_value**  
  (Optional) A field to supply extra values for the subject template. HTML entities in this field will be decoded before processing.

- **template_values**  
  A JSON string that contains key/value pairs for dynamic content replacements when processing the email body template.  
  _Example:_  
  ```json
  {"projectName": "New Building", "deadline": "2023-11-15"}
  ```

### Optional Columns

- **revu_session_invite**  
  Contains Bluebeam Revu session invite details. The script parses this column to extract a session ID (expected in the format `123-456-789`). If a valid session ID is found, it will be passed to the email template.  
  _Tip:_ Ensure the session invite text contains a valid session ID, as the first matching sequence in the invite text is used.

- **Additional Dynamic Columns**  
  Any extra columns added will be automatically passed as template variables available in the email body template.

---

## How the Script Works

1. **Row Processing**  
   The script processes rows in reverse order. Each row is validated for:
   - At least one non-empty value in `distribution_emails` or `additional_emails`
   - A valid URL in `email_body_template`

2. **Template Processing**  
   - The **email body** is generated by fetching the specified HTML template from Google Drive, merging it with values obtained from the JSON `template_values` column as well as any additional columns.
   - The **email subject** is generated solely from the `email_subject_template` column. Dynamic templating is supported; if no variables are provided, the content of the file is used directly. Otherwise, a default subject (configured in the system) is used as a fallback.

3. **Email Sending and Attachments Management**  
   - Email is sent via Gmail using the specified sender email (set in configuration).  
   - Upon successful sending, the script will automatically trash all files specified in the `attachments_urls` column. This helps ensure obsolete files aren't left on Drive.
   - If any errors occur during the trashing process, extra file metadata (including file name, owner, and sharing access information) is logged to help troubleshoot permissions or file existence issues.

4. **History Tracking**  
   Once an email is successfully sent, the corresponding row is moved to a history sheet (`sent_history`) along with a timestamp.

---

## Tips for End Users

- **Template Values JSON:** Always ensure that the JSON in the `template_values` column is valid. Use proper quotes and avoid extra escape characters.  
- **File URLs:** Only valid Google Drive URLs will work. Make sure each URL points to the correct file, and note that files will be trashed after processing.  
- **Bluebeam Session Invites:** If using Bluebeam invites, include a valid session ID (e.g., `123-456-789`) within the `revu_session_invite` text so it is automatically extracted.
- **Debugging:**  
  - If emails aren’t sending as expected, enable the script's debug mode by setting `DEBUG_MODE` to `true` in the configuration to log detailed error messages.
  - Check the email subject and body templates for proper placeholders corresponding to keys in your JSON.
  - Review the logged metadata when attachments cannot be trashed correctly.

---

## Getting Started

1. **Configure the Spreadsheet:**  
   - Ensure all required columns are present and populated.
   - Update your email templates on Google Drive with placeholders matching the keys from `template_values` or any additional column.

2. **Deploy the Script:**  
   - Open the Apps Script editor in the spreadsheet.
   - Deploy the script ensuring you grant all necessary permissions (Spreadsheet, Drive, Gmail).
  
3. **Run the Distribution:**  
   - You can manually run the `processEmailDistributions` function from the Apps Script console or use the custom menu added to the spreadsheet.

---

## Troubleshooting

- **Invalid File URLs:** Verify that URLs in `email_body_template` and `attachments_urls` are valid and accessible.
- **JSON Parsing Errors:** Check that the JSON in `template_values` is correctly formatted.
- **Permissions Issues:** Ensure that the account running the script has sufficient access to read the files and that file sharing settings allow processing.
- **Bluebeam Session Not Extracted:** Confirm that the `revu_session_invite` contains a valid session ID in the expected format.

---

For further assistance or to report issues, contact your system administrator or the support team.

Happy Document Distribution!
